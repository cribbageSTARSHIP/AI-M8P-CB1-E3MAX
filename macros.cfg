# Klipper Custom G-Code Macros - Updated & Organized for Mainsail
#
# In your slicer, set your start G-code to:
# PRINT_START BED_TEMP=[first_layer_bed_temperature] EXTRUDER_TEMP=[first_layer_temperature]
#
# And your end G-code to:
# PRINT_END
#

# --- 1. Core Print Workflows ---
[gcode_macro PRINT_START]
description: The primary macro called by your slicer to start a print.
gcode:
    _PRINT_START_LOGIC BED_TEMP={params.BED_TEMP} EXTRUDER_TEMP={params.EXTRUDER_TEMP}

[gcode_macro PRINT_END]
description: The primary macro called by your slicer to end a print.
gcode:
    _PRINT_END_LOGIC

[gcode_macro PRINT_PAUSE]
description: Pause the active print.
rename_existing: PAUSE_BASE
gcode:
    PAUSE_BASE
    _TOOLHEAD_PARK_PAUSE_CANCEL

[gcode_macro PRINT_RESUME]
description: Resume the active print.
rename_existing: RESUME_BASE
gcode:
    M109 S{printer.motion_queue.extruder_temp} ; Restore extruder temperature
    RESUME_BASE

[gcode_macro PRINT_CANCEL]
description: Cancel the active print.
rename_existing: CANCEL_PRINT_BASE
gcode:
    TURN_OFF_HEATERS
    _TOOLHEAD_PARK_PAUSE_CANCEL
    CLEAR_PAUSE
    SDCARD_RESET_FILE
    BASE_CANCEL

# --- 2. Filament Handling ---
[gcode_macro FILAMENT_CHANGE_M600]
description: Filament change command (M600 override).
gcode:
    PAUSE
    M117 Filament Change
    M118 Unload filament, then insert new filament.
    M118 Once ready, click RESUME.

[gcode_macro FILAMENT_LOAD]
description: Load filament into the extruder.
gcode:
    {% set TEMP = params.TEMP|default(210)|int %}
    M109 S{TEMP}
    M117 Loading Filament...
    G91
    G1 E50 F300
    G1 E40 F100
    G90
    M117 Filament Loaded

[gcode_macro FILAMENT_UNLOAD]
description: Unload filament from the extruder.
gcode:
    {% set TEMP = params.TEMP|default(210)|int %}
    M109 S{TEMP}
    M117 Unloading Filament...
    G91
    G1 E5 F300
    G1 E-10 F2000
    G1 E-70 F1500
    G90
    M117 Filament Unloaded

# --- 3. Diagnostics & Utilities ---
[gcode_macro DIAGS_TEST_SPEED]
description: Test for max speed and acceleration parameters.
gcode:
    {% set speed  = params.SPEED|default(printer.configfile.settings.printer.max_velocity)|int %}
    {% set iterations = params.ITERATIONS|default(5)|int %}
    {% set accel  = params.ACCEL|default(printer.configfile.settings.printer.max_accel)|int %}
    {% set bound = params.BOUND|default(20)|int %}
    {% set x_min = printer.toolhead.axis_minimum.x + bound %}
    {% set x_max = printer.toolhead.axis_maximum.x - bound %}
    {% set y_min = printer.toolhead.axis_minimum.y + bound %}
    {% set y_max = printer.toolhead.axis_maximum.y - bound %}

    SAVE_GCODE_STATE NAME=TEST_SPEED
    { action_respond_info("TEST_SPEED: starting %d iterations at speed %d, accel %d" % (iterations, speed, accel)) }
    G28
    G0 X{x_min} Y{y_min} Z{bound + 10} F{speed*60}
    SET_VELOCITY_LIMIT VELOCITY={speed} ACCEL={accel}
    {% for i in range(iterations) %}
        G0 X{x_min} Y{y_min} F{speed*60}
        G0 X{x_max} Y{y_max} F{speed*60}
        G0 X{x_max} Y{y_min} F{speed*60}
        G0 X{x_min} Y{y_max} F{speed*60}
    {% endfor %}
    SET_VELOCITY_LIMIT VELOCITY={printer.configfile.settings.printer.max_velocity} ACCEL={printer.configfile.settings.printer.max_accel}
    G28
    RESTORE_GCODE_STATE NAME=TEST_SPEED

[gcode_macro DIAGS_BED_HEATSOAK]
description: Heats the bed to a set temperature for a specified time.
gcode:
    M117 Homing...
    G28
    M117 Lifting gantry...
    G90
    G1 Z200 F3000
    {% set T = params.TEMP|default(60)|int %}
    {% set M = params.TIME|default(30)|int %}
    M117 Heating bed to {T}C for {M} mins.
    SET_HEATER_TEMPERATURE HEATER=heater_bed TARGET={T}
    G4 P{M * 60000}
    SET_HEATER_TEMPERATURE HEATER=heater_bed TARGET=0
    M117 Bed heating complete.

# --- 4. Compatibility Macros & Overrides ---
[gcode_macro G29]
description: Override G29 to run KAMP's adaptive bed mesh.
gcode:
    BED_MESH_CLEAR
    BED_MESH_CALIBRATE ADAPTIVE=1

# --- 5. Hidden Helper Macros ---
[gcode_macro _PRINT_START_LOGIC]
description: The core startup sequence for a print, integrated with KAMP.
gcode:
    {% set BED_TEMP = params.BED_TEMP|default(60)|float %}
    {% set EXTRUDER_TEMP = params.EXTRUDER|default(210)|float %}

    M117 Homing...
    _CG28 ; Conditional home

    M117 Heating Bed to {BED_TEMP}C...
    M190 S{BED_TEMP}

    M117 Heating Hotend to 150C for probing...
    M109 S150

    M117 Creating Bed Mesh...
    BED_MESH_CALIBRATE ADAPTIVE=1

    M117 Heating Hotend to {EXTRUDER_TEMP}C...
    M109 S{EXTRUDER_TEMP}
    
    M117 Print Starting!

[gcode_macro _PRINT_END_LOGIC]
description: The core shutdown sequence for a print.
gcode:
    {% set max_x = printer.configfile.config["stepper_x"]["position_max"]|float %}
    {% set max_y = printer.configfile.config["stepper_y"]["position_max"]|float %}

    M400 ; Wait for buffer to clear
    G92 E0 ; Zero the extruder
    G1 E-4.0 F3600 ; Retract filament
    
    G90 ; Absolute positioning
    G0 X{max_x / 2} Y{max_y - 10} F3600 ; Move to back-center

    TURN_OFF_HEATERS
    M107 ; Turn off part cooling fan
    
    M84 ; Disable motors
    
    M117 Print Finished!

[gcode_macro _TOOLHEAD_PARK_PAUSE_CANCEL]
description: Helper macro to park the toolhead during a pause or cancel.
gcode:
    SAVE_GCODE_STATE NAME=PAUSE_PARK
    G90
    G1 Z{printer.toolhead.position.z + 5} F19000
    G1 X{printer.toolhead.axis_maximum.x / 2} Y{printer.toolhead.axis_minimum.y + 5} F19000
    RESTORE_GCODE_STATE NAME=PAUSE_PARK

[gcode_macro _CG28]
description: Conditional G28 (home only if needed).
gcode:
    {% if "xyz" not in printer.toolhead.homed_axes %}
        G28
    {% endif %}
