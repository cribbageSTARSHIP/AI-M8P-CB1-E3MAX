# macros/calibration/calibration.cfg
#
# This file contains general-purpose macros for printer calibration and
# utility functions. It includes routines for bed meshing, probe
# calibration preparation, and accepting/saving configurations.
#

[gcode_macro PREPARE_PROBE_CALIBRATION]
description: "Homes, heats, and stabilizes the printer for a PROBE_CALIBRATE."
gcode:
    # Get temperature parameters from the user interface, with safe defaults.
    {% set BED_TEMP = params.BED_TEMP|default(60)|float %}
    {% set NOZZLE_TEMP = params.NOZZLE_TEMP|default(150)|float %}

    M117 Homing if necessary...
    # Step 1: Check homing status and home if needed.
    {% if 'x' not in printer.toolhead.homed_axes or 'y' not in printer.toolhead.homed_axes or 'z' not in printer.toolhead.homed_axes %}
      G28
    {% endif %}

    M117 Heating bed to {BED_TEMP}C and nozzle to {NOZZLE_TEMP}C...
    # Step 4 & 5: Set bed and hotend temperatures (without waiting).
    M140 S{BED_TEMP}
    M104 S{NOZZLE_TEMP}

    # Step 6: Wait for both to reach their target temperatures.
    M190 S{BED_TEMP}
    M109 S{NOZZLE_TEMP}

    M117 Stabilizing for 60 seconds...
    # Step 6 (continued): Wait an additional 60 seconds for thermal stabilization.
    G4 S60

    M117 Ready for PROBE_CALIBRATE.
    # Step 7: Start the interactive probe calibration process.
    PROBE_CALIBRATE

# Add other general calibration macros like RUN_BED_MESH, ACCEPT, and SAVE_CONF here.
