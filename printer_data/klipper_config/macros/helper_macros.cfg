# macros/helper_macros.cfg
# Internal helper macros used by other macros

[gcode_macro _PRINT_START_LOGIC]
description: The core startup sequence for a print, integrated with KAMP.
gcode:
    {% set BED_TEMP = params.BED_TEMP|default(60)|float %}
    {% set EXTRUDER_TEMP = params.EXTRUDER|default(210)|float %}

    M117 Homing...
    _CG28 ; Conditional home

    M117 Heating Bed to {BED_TEMP}C...
    M190 S{BED_TEMP}

    M117 Heating Hotend to 150C for probing...
    M109 S150

    M117 Creating Bed Mesh...
    BED_MESH_CALIBRATE ADAPTIVE=1

    M117 Heating Hotend to {EXTRUDER_TEMP}C...
    M109 S{EXTRUDER_TEMP}
    
    M117 Print Starting!

[gcode_macro _PRINT_END_LOGIC]
description: The core shutdown sequence for a print.
gcode:
    {% set max_x = printer.configfile.config["stepper_x"]["position_max"]|float %}
    {% set max_y = printer.configfile.config["stepper_y"]["position_max"]|float %}

    M400 ; Wait for buffer to clear
    G92 E0 ; Zero the extruder
    G1 E-4.0 F3600 ; Retract filament
    
    G90 ; Absolute positioning
    G0 X{max_x / 2} Y{max_y - 10} F3600 ; Move to back-center

    TURN_OFF_HEATERS
    M107 ; Turn off part cooling fan
    
    M84 ; Disable motors
    
    M117 Print Finished!

[gcode_macro _TOOLHEAD_PARK_PAUSE_CANCEL]
description: Helper macro to park the toolhead during a pause or cancel.
gcode:
    SAVE_GCODE_STATE NAME=PAUSE_PARK
    G90
    G1 Z{printer.toolhead.position.z + 5} F19000
    G1 X{printer.toolhead.axis_maximum.x / 2} Y{printer.toolhead.axis_minimum.y + 5} F19000
    RESTORE_GCODE_STATE NAME=PAUSE_PARK

[gcode_macro _CG28]
description: Conditional G28 (home only if needed).
gcode:
    {% if "xyz" not in printer.toolhead.homed_axes %}
        G28
    {% endif %}
